# üéÆ Syst√®me Lua Console Hook - Documentation Compl√®te

## üìã Vue d'ensemble

Le **Syst√®me Lua Console Hook** est une solution compl√®te de surveillance automatique des erreurs Lua pour vos serveurs Garry's Mod. Il capture en temps r√©el toutes les erreurs avec leurs stack traces compl√®tes et les enregistre automatiquement en base de donn√©es.

## ‚ú® Fonctionnalit√©s principales

### üîç **Surveillance automatique**
- D√©tection en temps r√©el des erreurs Lua `[ERROR]`
- Filtrage automatique des serveurs Garry's Mod uniquement
- Surveillance continue avec intervalle configurable (1s √† 60s)

### üìä **Capture compl√®te des erreurs**
- Message d'erreur complet
- Stack trace d√©taill√©e
- Contexte de l'erreur
- Timestamp de d√©tection
- Identification de l'addon responsable

### üöÄ **Modes d'ex√©cution**
- **Mode console** : Surveillance en temps r√©el avec affichage live
- **Mode daemon** : Service en arri√®re-plan avec gestion des processus
- **Mode debug** : Test sans base de donn√©es avec serveurs simul√©s

### üéØ **Filtrage intelligent**
- Serveurs Garry's Mod uniquement
- Filtrage par ID de serveur sp√©cifique
- Exclusion des serveurs suspendus ou non install√©s

## üõ†Ô∏è Installation et configuration

### 1. **V√©rification des pr√©requis**
```bash
# V√©rifier que PHP a les extensions n√©cessaires
php -m | grep -E "(pcntl|posix)"

# V√©rifier que Laravel est install√©
php artisan --version
```

### 2. **Structure des fichiers**
```
app/
‚îú‚îÄ‚îÄ Console/Commands/
‚îÇ   ‚îú‚îÄ‚îÄ MonitorLuaConsole.php          # Surveillance en temps r√©el
‚îÇ   ‚îú‚îÄ‚îÄ AnalyzeLuaLogs.php             # Analyse des logs
‚îÇ   ‚îú‚îÄ‚îÄ LuaConsoleDaemon.php           # Gestion du daemon
‚îÇ   ‚îî‚îÄ‚îÄ InsertTestLuaErrors.php        # Insertion d'erreurs de test
‚îú‚îÄ‚îÄ Services/Servers/
‚îÇ   ‚îú‚îÄ‚îÄ LuaConsoleHookService.php      # Service principal
‚îÇ   ‚îî‚îÄ‚îÄ LuaLogService.php              # Gestion des logs
‚îú‚îÄ‚îÄ Filament/Pages/
‚îÇ   ‚îú‚îÄ‚îÄ LuaConsoleDaemonControl.php    # Contr√¥le du daemon
‚îÇ   ‚îî‚îÄ‚îÄ LuaErrorDashboard.php          # Dashboard des erreurs
‚îî‚îÄ‚îÄ Models/
    ‚îî‚îÄ‚îÄ LuaError.php                   # Mod√®le des erreurs
```

## üöÄ Utilisation

### **Commandes Artisan principales**

#### 1. **Surveillance en temps r√©el**
```bash
# Surveillance de tous les serveurs GMod
php artisan lua:monitor --stream

# Surveillance d'un serveur sp√©cifique
php artisan lua:monitor --server=123 --stream

# Mode debug avec serveurs simul√©s
php artisan lua:monitor --debug --stream

# Combinaison des options
php artisan lua:monitor --server=123 --debug --stream
```

#### 2. **Gestion du daemon**
```bash
# D√©marrer le daemon
php artisan lua:daemon start --server=123 --interval=5

# V√©rifier le statut
php artisan lua:daemon status

# Arr√™ter le daemon
php artisan lua:daemon stop

# Red√©marrer le daemon
php artisan lua:daemon restart
```

#### 3. **Analyse des logs**
```bash
# Analyser un fichier sp√©cifique
php artisan lua:analyze-logs --file=/path/to/log.txt

# Analyser les logs d'un serveur
php artisan lua:analyze-logs --server=123

# Exporter en diff√©rents formats
php artisan lua:analyze-logs --output=json --errors-only
```

#### 4. **Tests et d√©veloppement**
```bash
# Ins√©rer des erreurs de test
php artisan lua:insert-test-errors 123 --count=10

# Test complet du syst√®me
php test_lua_system.php
```

### **Interface web Filament**

#### 1. **Contr√¥le du Daemon** (`/admin/lua-console-daemon`)
- Statut en temps r√©el du daemon
- Contr√¥les de d√©marrage/arr√™t/red√©marrage
- Configuration de l'intervalle de surveillance
- Actualisation automatique de l'interface

#### 2. **Dashboard des Erreurs** (`/admin/lua-error-dashboard`)
- Statistiques globales des erreurs
- Erreurs r√©centes avec d√©tails
- R√©partition des erreurs par serveur
- Actions rapides vers les autres pages

#### 3. **Logger d'Erreurs** (`/admin/lua-error-logger`)
- Affichage des erreurs par serveur
- Gestion du statut (ouvert/r√©solu/ferm√©)
- Stack traces d√©taill√©es
- Filtres et recherche

## üîß Configuration avanc√©e

### **Variables d'environnement**
```env
# Intervalle de surveillance par d√©faut (secondes)
LUA_CONSOLE_CHECK_INTERVAL=5

# Mode debug (true/false)
LUA_CONSOLE_DEBUG_MODE=false

# Fichier PID du daemon
LUA_CONSOLE_PID_FILE=storage/lua-console-hook.pid
```

### **Personnalisation des patterns d'erreur**
Dans `LuaConsoleHookService.php`, modifiez la m√©thode `isLuaError()` :
```php
private function isLuaError(string $line): bool
{
    $patterns = [
        '/\[ERROR\]/i',
        '/Lua Error:/i',
        '/Script Error:/i',
        // Ajoutez vos patterns personnalis√©s ici
    ];
    
    foreach ($patterns as $pattern) {
        if (preg_match($pattern, $line)) {
            return true;
        }
    }
    
    return false;
}
```

## üìä Structure de la base de donn√©es

### **Table `lua_errors`**
```sql
CREATE TABLE lua_errors (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    server_id BIGINT UNSIGNED NOT NULL,
    error_key VARCHAR(255) UNIQUE NOT NULL,
    level ENUM('ERROR', 'WARNING', 'INFO') DEFAULT 'ERROR',
    message TEXT NOT NULL,
    addon VARCHAR(255) NULL,
    stack_trace TEXT NULL,
    context TEXT NULL,
    count INT UNSIGNED DEFAULT 1,
    first_seen TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_seen TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status ENUM('open', 'resolved', 'closed') DEFAULT 'open',
    resolved BOOLEAN DEFAULT FALSE,
    resolved_at TIMESTAMP NULL,
    closed_at TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_server_status (server_id, status),
    INDEX idx_error_key (error_key),
    INDEX idx_last_seen (last_seen)
);
```

## üß™ Tests et d√©bogage

### **Mode debug**
Le mode debug permet de tester le syst√®me sans base de donn√©es :
```php
$hookService = app(LuaConsoleHookService::class);
$hookService->setDebugMode(true);
$hookService->enableStreamingMode();
$hookService->startHooking();
```

### **Serveurs simul√©s**
En mode debug, le syst√®me cr√©e des serveurs de test avec des erreurs simul√©es :
- **GMod Test Server 1** : Erreurs d'addons
- **GMod Test Server 2** : Erreurs de scripts
- **GMod Test Server 3** : Erreurs de ressources

### **Script de test complet**
```bash
# Ex√©cuter le test complet
php test_lua_system.php

# Ce script teste :
# 1. Initialisation du service
# 2. Cr√©ation des serveurs de test
# 3. Surveillance en streaming
# 4. D√©tection d'erreurs simul√©es
```

## üö® D√©pannage

### **Probl√®mes courants**

#### 1. **"Target class does not exist"**
```bash
# V√©rifier que le service est bien cr√©√©
php artisan make:service LuaConsoleHookService

# V√©rifier l'autoload
composer dump-autoload
```

#### 2. **Erreurs de connexion √† la base**
```bash
# Utiliser le mode debug
php artisan lua:monitor --debug

# V√©rifier la configuration DB
php artisan config:show database
```

#### 3. **Daemon ne d√©marre pas**
```bash
# V√©rifier les permissions
chmod +x storage/
chmod 666 storage/lua-console-hook.pid

# V√©rifier les extensions PHP
php -m | grep pcntl
```

#### 4. **Aucune erreur d√©tect√©e**
```bash
# V√©rifier que les serveurs sont GMod
php artisan tinker --execute="App\Models\Server::where('egg_id', 1)->get()"

# V√©rifier les patterns de d√©tection
php artisan lua:monitor --debug --stream
```

### **Logs et monitoring**
```bash
# Logs Laravel
tail -f storage/logs/laravel.log

# Logs du daemon
tail -f storage/logs/lua-console-hook.log

# Statut du processus
ps aux | grep lua-console-hook
```

## üîÑ Mise √† jour et maintenance

### **Mise √† jour du syst√®me**
```bash
# Pull des derni√®res modifications
git pull origin main

# Mise √† jour des d√©pendances
composer update

# Nettoyage du cache
php artisan cache:clear
php artisan config:clear
```

### **Maintenance du daemon**
```bash
# Red√©marrer le service
php artisan lua:daemon restart

# V√©rifier l'int√©grit√©
php artisan lua:daemon status

# Nettoyer les anciens processus
pkill -f lua-console-hook
```

## üìà Performance et optimisation

### **Recommandations**
- **Intervalle optimal** : 5-10 secondes pour la plupart des cas
- **Mode streaming** : Pour le d√©veloppement et le debugging
- **Mode daemon** : Pour la production avec surveillance continue
- **Cache des erreurs** : √âvite la duplication des erreurs identiques

### **Monitoring des ressources**
```bash
# Utilisation CPU
top -p $(cat storage/lua-console-hook.pid)

# Utilisation m√©moire
ps -o pid,ppid,cmd,%mem,%cpu --pid=$(cat storage/lua-console-hook.pid)

# Logs de performance
tail -f storage/logs/lua-console-hook.log | grep "PERF"
```

## ü§ù Support et contribution

### **Rapport de bugs**
1. V√©rifiez les logs : `storage/logs/laravel.log`
2. Testez en mode debug : `php artisan lua:monitor --debug`
3. V√©rifiez la configuration de la base de donn√©es
4. Cr√©ez une issue avec les d√©tails complets

### **Am√©liorations sugg√©r√©es**
- Interface de configuration avanc√©e
- Notifications par email/Slack
- Int√©gration avec d'autres syst√®mes de monitoring
- API REST pour l'int√©gration externe
- M√©triques et graphiques de performance

---

## üéØ **R√©sum√© des commandes principales**

| Commande | Description | Options |
|----------|-------------|---------|
| `lua:monitor` | Surveillance en temps r√©el | `--server`, `--stream`, `--debug` |
| `lua:daemon` | Gestion du service | `start`, `stop`, `status`, `restart` |
| `lua:analyze-logs` | Analyse des logs | `--file`, `--server`, `--output` |
| `lua:insert-test-errors` | Erreurs de test | `--count` |

## üåü **Fonctionnalit√©s cl√©s**

‚úÖ **Surveillance automatique** des serveurs GMod  
‚úÖ **D√©tection en temps r√©el** des erreurs Lua  
‚úÖ **Stack traces compl√®tes** avec contexte  
‚úÖ **Service daemon** en arri√®re-plan  
‚úÖ **Interface web** compl√®te dans Filament  
‚úÖ **Mode debug** pour les tests  
‚úÖ **Filtrage intelligent** des serveurs  
‚úÖ **Enregistrement automatique** en base  
‚úÖ **Gestion des erreurs** (ouvert/r√©solu/ferm√©)  
‚úÖ **Export** dans plusieurs formats  

---

**üéÆ Votre syst√®me de surveillance Lua est maintenant op√©rationnel !** üöÄ
